<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  {% load static %}
  <link rel="stylesheet" href="{% static 'classifier/custom.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>Dermatology AI Assistant | Skin Lesion Analysis</title>
  <meta name="description" content="Advanced AI-powered dermatology assistant for preliminary skin lesion analysis using computer vision technology.">
  <style>
    .professional-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .professional-header h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #2c3e50 0%, #3498db 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .professional-header .subtitle {
      font-size: 1.2rem;
      color: #5a6c7d;
      max-width: 700px;
      margin: 0 auto 25px;
      line-height: 1.6;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .feature-item {
      text-align: center;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    .feature-item i {
      font-size: 2rem;
      color: #3498db;
      margin-bottom: 15px;
    }
    
    .feature-item h4 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .feature-item p {
      color: #64748b;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .disclaimer-card {
      background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
      border-left: 4px solid #ff9800;
      padding: 25px;
      border-radius: 12px;
      margin-top: 40px;
    }
    
    .disclaimer-card h4 {
      color: #ff6f00;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .disclaimer-card p {
      color: #5d4037;
      line-height: 1.7;
      font-size: 0.95rem;
    }
    
    .result-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      border: 2px solid #e2e8f0;
      display: none;
    }
    
    .result-card.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .confidence-meter {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
      border-radius: 4px;
      width: 0%;
      transition: width 1s ease-out;
    }
    
    .professional-footer {
      margin-top: 60px;
      padding-top: 30px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      color: #64748b;
      font-size: 0.9rem;
    }
    
    .professional-footer .copyright {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #94a3b8;
    }
    
    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .card-title i {
      font-size: 1.5rem;
      color: #3498db;
    }
    
    .card-title h3 {
      margin: 0;
      font-size: 1.4rem;
      color: #2c3e50;
    }
    
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #4a5568;
    }
    
    .input-hint {
      font-size: 0.85rem;
      color: #718096;
      margin-top: 5px;
      margin-bottom: 15px;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    
    .button-group button {
      flex: 1;
      min-width: 150px;
    }
    
    @media (max-width: 768px) {
      .professional-header h1 {
        font-size: 1.8rem;
      }
      
      .professional-header .subtitle {
        font-size: 1rem;
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group button {
        min-width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- Toast container for notifications -->
  <div id="toastRoot" class="toast-root"></div>

  <!-- Main application wrapper -->
  <div class="app">
    <!-- Professional Header -->
    <div class="professional-header">
      <h1>Dermatology AI Assistant</h1>
      <p class="subtitle">
        Advanced computer vision technology for preliminary analysis of skin lesions. 
        Our AI assistant provides instant, non-invasive assessment to support healthcare decisions.
      </p>
      
      <div class="feature-grid">
        <div class="feature-item">
          <i class="fas fa-robot"></i>
          <h4>AI-Powered Analysis</h4>
          <p>Utilizes deep learning algorithms trained on thousands of dermatological images</p>
        </div>
        <div class="feature-item">
          <i class="fas fa-bolt"></i>
          <h4>Real-Time Processing</h4>
          <p>Instant analysis with live webcam capability for immediate feedback</p>
        </div>
        <div class="feature-item">
          <i class="fas fa-chart-line"></i>
          <h4>Confidence Scoring</h4>
          <p>Detailed confidence metrics and top-5 predictions for comprehensive assessment</p>
        </div>
      </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
      <!-- Image Analysis Card -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-file-image"></i>
          <h3>Image Analysis</h3>
        </div>
        
        <label class="input-label">Upload Dermatological Image</label>
        <input type="file" id="fileInput" accept="image/*" />
        <p class="input-hint">Supported formats: JPG, PNG, WEBP | Max size: 10MB</p>
        
        <div class="button-group">
          <button id="btnPredictUpload" class="primary-button">
            <i class="fas fa-search"></i> Analyze Image
          </button>
        </div>
        
        <div id="uploadResult" class="result-card">
          <!-- Results will appear here -->
        </div>
      </div>

      <!-- Live Analysis Card -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-video"></i>
          <h3>Live Analysis</h3>
        </div>
        
        <div class="video-container">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>
        
        <div class="button-group">
          <button id="btnStart" class="success-button">
            <i class="fas fa-play"></i> Start Camera
          </button>
          <button id="btnStop" disabled class="danger-button">
            <i class="fas fa-stop"></i> Stop Camera
          </button>
          <button id="btnLive" disabled class="warning-button">
            <i class="fas fa-broadcast-tower"></i> Start Live Analysis
          </button>
        </div>
        
        <div id="camResult" class="result-card">
          <!-- Results will appear here -->
        </div>
        
        <p class="input-hint">
          <i class="fas fa-info-circle"></i> Live analysis processes frames every 700ms for real-time feedback. 
          Ensure good lighting and clear focus on the affected area.
        </p>
      </div>
    </div>

    <!-- Medical Disclaimer -->
    <div class="disclaimer-card">
      <h4><i class="fas fa-exclamation-triangle"></i> Important Medical Disclaimer</h4>
      <p>
        This tool is designed for preliminary analysis and educational purposes only. It is not a substitute for 
        professional medical advice, diagnosis, or treatment. Always seek the advice of a qualified healthcare 
        provider with any questions you may have regarding a medical condition. Never disregard professional 
        medical advice or delay in seeking it because of something you have read or seen in this application.
        The AI model provides probabilistic assessments and should be interpreted by trained medical professionals.
      </p>
    </div>

    <!-- Professional Footer -->
    <div class="professional-footer">
      <p><strong>Dermatology AI Assistant</strong> â€“ Bridging Technology and Dermatological Care</p>
      <div class="copyright">
        &copy; 2024-2026 Adeolu Olofintuyi. All rights reserved.<br>
        <small>This software is for research and educational purposes.</small>
      </div>
    </div>
  </div>

  <!-- Include JavaScript -->
  <script src="{% static 'classifier/style.js' %}"></script>
  
  <!-- Updated inline JavaScript with professional enhancements -->
  <script>
    function renderResult(el, data) {
      if (data.error) {
        el.innerHTML = `
          <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 20px; border-radius: 8px;">
            <h4 style="color: #d32f2f; margin-bottom: 10px;"><i class="fas fa-exclamation-circle"></i> Analysis Error</h4>
            <p style="color: #5d4037;">${data.error}</p>
          </div>
        `;
        el.classList.add('active');
        return;
      }
      
      if (data.rejected) {
        const confPct = (data.confidence * 100).toFixed(2);
        el.innerHTML = `
          <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px;">
            <h4 style="color: #ef6c00; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Insufficient Confidence</h4>
            <p style="color: #5d4037; margin-bottom: 15px;">
              The analysis indicates <strong>${data.label}</strong> with <strong>${confPct}% confidence</strong>.
              This result suggests the image may require clearer visualization for accurate assessment.
            </p>
            <div class="confidence-meter">
              <div class="confidence-fill" style="width: ${confPct}%"></div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #fff8e1; border-radius: 8px;">
              <p style="color: #5d4037; margin: 0; font-size: 0.9rem;">
                <i class="fas fa-lightbulb"></i> <strong>Recommendation:</strong> Capture a clearer, well-lit image focused on the affected area.
              </p>
            </div>
          </div>
        `;
        el.classList.add('active');
        setTimeout(() => {
          document.querySelector('.confidence-fill').style.width = '0%';
          setTimeout(() => {
            document.querySelector('.confidence-fill').style.width = confPct + '%';
          }, 100);
        }, 100);
        return;
      }
      
      const top1 = data.top1;
      const confPct = (top1.confidence * 100).toFixed(2);
      
      let html = `
        <div style="margin-bottom: 25px;">
          <h4 style="color: #2c3e50; margin-bottom: 15px;"><i class="fas fa-diagnoses"></i> Primary Assessment</h4>
          <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <span style="font-size: 1.2rem; font-weight: 600; color: #2e7d32;">${top1.label}</span>
              <span style="font-size: 1.4rem; font-weight: 700; color: #1b5e20;">${confPct}%</span>
            </div>
            <div class="confidence-meter">
              <div class="confidence-fill" style="width: ${confPct}%"></div>
            </div>
            <p style="color: #388e3c; margin-top: 10px; font-size: 0.9rem;">
              <i class="fas fa-chart-line"></i> Model confidence level
            </p>
          </div>
        </div>
        
        <div>
          <h4 style="color: #2c3e50; margin-bottom: 15px;"><i class="fas fa-list-ol"></i> Differential Diagnosis (Top 5)</h4>
          <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
            <ol style="margin: 0; padding-left: 20px;">
      `;
      
      data.top5.forEach((x, index) => {
        const percentage = (x.confidence * 100).toFixed(2);
        const barWidth = Math.min(percentage, 100);
        const intensity = Math.min(100 + (percentage * 1.5), 255);
        html += `
          <li style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: ${index === data.top5.length - 1 ? 'none' : '1px solid #e0e0e0'};">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="font-weight: 600; color: #37474f;">
                <span style="display: inline-block; width: 25px; height: 25px; background: #3498db; color: white; border-radius: 50%; text-align: center; line-height: 25px; margin-right: 10px; font-size: 0.9rem;">
                  ${index + 1}
                </span>
                ${x.label}
              </span>
              <span style="font-weight: 700; color: #455a64;">${percentage}%</span>
            </div>
            <div class="confidence-meter">
              <div class="confidence-fill" style="width: ${barWidth}%; background: linear-gradient(90deg, rgba(52, 152, 219, 0.8) 0%, rgba(41, 128, 185, 0.8) 100%);"></div>
            </div>
          </li>
        `;
      });
      
      html += `
            </ol>
            <p style="color: #546e7a; margin-top: 15px; font-size: 0.9rem; font-style: italic;">
              <i class="fas fa-info-circle"></i> Differential diagnoses are listed in order of model confidence.
            </p>
          </div>
        </div>
      `;
      
      el.innerHTML = html;
      el.classList.add('active');
      
      // Animate confidence bars
      setTimeout(() => {
        document.querySelectorAll('.confidence-fill').forEach(bar => {
          const width = bar.style.width;
          bar.style.width = '0%';
          setTimeout(() => {
            bar.style.width = width;
          }, 100);
        });
      }, 300);
    }

    // Upload analysis handler
    document.getElementById("btnPredictUpload").addEventListener("click", async () => {
      const fileInput = document.getElementById("fileInput");
      const resultEl = document.getElementById("uploadResult");
      const button = document.getElementById("btnPredictUpload");
      
      if (!fileInput.files[0]) { 
        resultEl.innerHTML = `
          <div style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px;">
            <h4 style="color: #ef6c00; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> No Image Selected</h4>
            <p style="color: #5d4037;">Please select an image file for analysis.</p>
          </div>
        `;
        resultEl.classList.add('active');
        return; 
      }

      // Show loading state
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
      button.disabled = true;

      const form = new FormData();
      form.append("image", fileInput.files[0]);

      try {
        const res = await fetch("/predict/", { method: "POST", body: form });
        const data = await res.json();
        
        if (!res.ok) { 
          throw new Error(data.error || "Analysis failed"); 
        }
        
        renderResult(resultEl, data);
      } catch (error) {
        resultEl.innerHTML = `
          <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 20px; border-radius: 8px;">
            <h4 style="color: #d32f2f; margin-bottom: 10px;"><i class="fas fa-exclamation-circle"></i> Analysis Error</h4>
            <p style="color: #5d4037;">${error.message}</p>
          </div>
        `;
        resultEl.classList.add('active');
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    });

    // Webcam functionality
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnLive = document.getElementById("btnLive");
    const camResult = document.getElementById("camResult");

    let stream = null;
    let liveTimer = null;

    btnStart.addEventListener("click", async () => {
      try {
        btnStart.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
        btnStart.disabled = true;
        
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' }, 
          audio: false 
        });
        video.srcObject = stream;
        
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnLive.disabled = false;
        btnStart.innerHTML = '<i class="fas fa-play"></i> Start Camera';
        
        // Show success toast
        const toast = document.getElementById('toastRoot');
        if (toast) {
          toast.innerHTML = `
            <div class="toast success">
              <span><i class="fas fa-check-circle"></i> Camera initialized successfully</span>
              <button class="toast-close">&times;</button>
            </div>
          `;
        }
      } catch (error) {
        console.error("Camera error:", error);
        btnStart.innerHTML = '<i class="fas fa-play"></i> Start Camera';
        btnStart.disabled = false;
        
        camResult.innerHTML = `
          <div style="background: #ffebee; border-left: 4px solid #f44336; padding: 20px; border-radius: 8px;">
            <h4 style="color: #d32f2f; margin-bottom: 10px;"><i class="fas fa-video-slash"></i> Camera Error</h4>
            <p style="color: #5d4037;">
              Unable to access camera. Please ensure camera permissions are granted and try again.
            </p>
          </div>
        `;
        camResult.classList.add('active');
      }
    });

    btnStop.addEventListener("click", () => {
      if (liveTimer) { 
        clearInterval(liveTimer); 
        liveTimer = null; 
        btnLive.innerHTML = '<i class="fas fa-broadcast-tower"></i> Start Live Analysis';
      }
      
      if (stream) { 
        stream.getTracks().forEach(t => t.stop()); 
        stream = null; 
      }
      
      video.srcObject = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnLive.disabled = true;
    });

    async function sendFrameOnce() {
      if (!stream) return;
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) return;

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.85));
      const form = new FormData();
      form.append("frame", blob, "frame.jpg");

      try {
        const res = await fetch("/predict-frame/", { method: "POST", body: form });
        const data = await res.json();
        if (res.ok) renderResult(camResult, data);
      } catch (error) {
        console.error("Frame analysis error:", error);
      }
    }

    btnLive.addEventListener("click", () => {
      if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
        btnLive.innerHTML = '<i class="fas fa-broadcast-tower"></i> Start Live Analysis';
        return;
      }
      liveTimer = setInterval(sendFrameOnce, 700);
      btnLive.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Live Analysis';
    });

    // Initialize toast system if not already present
    if (!document.querySelector('.toast')) {
      const style = document.createElement('style');
      style.textContent = `
        .toast {
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          margin-bottom: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .toast.success {
          background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
        }
        .toast.error {
          background: linear-gradient(90deg, #f44336 0%, #d32f2f 100%);
        }
        .toast.info {
          background: linear-gradient(90deg, #2196F3 0%, #1976D2 100%);
        }
        .toast.warning {
          background: linear-gradient(90deg, #ff9800 0%, #f57c00 100%);
        }
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        .toast-close {
          background: none;
          border: none;
          color: white;
          margin-left: 15px;
          cursor: pointer;
          font-size: 1.2rem;
        }
      `;
      document.head.appendChild(style);
    }
  </script>
</body>
</html>